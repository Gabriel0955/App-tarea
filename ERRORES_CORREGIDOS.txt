# Script para corregir errores en producciÃ³n

## âœ… Errores Corregidos

### 1. âŒ Error: Undefined variable $start_date en calendar.php
**LÃ­nea 33-35**
```
PHP Warning: Undefined variable $start_date
PHP Deprecated: strtotime(): Passing null to parameter #1
```

**SoluciÃ³n:** Definir `$start_date` antes de usarla:
```php
$start_date = sprintf('%04d-%02d-01', $year, $month);
```

### 2. âŒ Error: Undefined array key "unlocked" en achievements.php
**LÃ­nea 37** (mÃºltiples warnings)
```
PHP Warning: Undefined array key "unlocked"
```

**SoluciÃ³n:** Cambiar de `$a['unlocked']` a `$a['is_unlocked']` para coincidir con el nombre del campo en SQL:
```php
// ANTES
$unlocked_count = count(array_filter($achievements, function($a) { return $a['unlocked']; }));

// DESPUÃ‰S
$unlocked_count = count(array_filter($achievements, function($a) { return $a['is_unlocked'] ?? false; }));
```

### 3. âŒ Error: Column "status" does not exist en TaskService.php
**LÃ­nea 191**
```
PDOException: SQLSTATE[42703]: Undefined column: 7 ERROR: column "status" of relation "tasks" does not exist
```

**SoluciÃ³n:** Eliminar la columna `status` del UPDATE ya que no existe en la tabla:
```php
// ANTES (con status)
UPDATE tasks SET deployed = 1, ..., status = ? WHERE id = ?

// DESPUÃ‰S (sin status)
UPDATE tasks SET deployed = 1, ... WHERE id = ?
```

### 4. âŒ Error: Tabla quick_tasks no existe
**QuickTaskService.php lÃ­nea 52**
```
PDOException: relation "quick_tasks" does not exist
```

**SoluciÃ³n:** 
- Agregado manejo de excepciones para detectar si tabla no existe
- PÃ¡gina quick_tasks.php ahora muestra mensaje amigable con instrucciones
- Devuelve array vacÃ­o en lugar de error fatal

## ğŸ“ Archivos Modificados

1. âœ… `public/tasks/calendar.php` - Variable $start_date definida
2. âœ… `public/gamification/achievements.php` - Campo cambiado a 'is_unlocked' con null coalescing
3. âœ… `services/TaskService.php` - Columna status eliminada del UPDATE
4. âœ… `services/QuickTaskService.php` - Manejo de error cuando tabla no existe
5. âœ… `public/tasks/quick_tasks.php` - Mensaje de alerta si tabla no existe, verificaciÃ³n de elementos DOM

## ğŸš€ Desplegar Cambios

```powershell
# Subir cambios a Git
cd c:\wamp64\www\App-Tareas
git add .
git commit -m "Fix: Corregir variables indefinidas, campo is_unlocked y manejo de tabla inexistente"
git push origin main
```

## âš ï¸ IMPORTANTE: Ejecutar MigraciÃ³n

Para habilitar Tareas RÃ¡pidas, ejecutar:

```powershell
cd c:\wamp64\www\App-Tareas
$env:PGPASSWORD="Gabriel1405"
psql -h apptarea.postgres.database.azure.com -U apptarea -d postgres -p 5432 -f db\add_quick_tasks.sql
```

O desde **pgAdmin**:
1. Conectar a `apptarea.postgres.database.azure.com`
2. Abrir Query Tool
3. Copiar contenido de `db/add_quick_tasks.sql`
4. Ejecutar (F5)

## âœ¨ Resultado Esperado

DespuÃ©s de desplegar estos cambios:

- âœ… No mÃ¡s warnings de "Undefined variable $start_date"
- âœ… No mÃ¡s warnings de "Undefined array key 'unlocked'"
- âœ… No mÃ¡s errores 500 al marcar tareas como desplegadas
- âœ… No mÃ¡s errores de columna "status" inexistente
- âœ… Mensaje amigable si tabla quick_tasks no existe
- âœ… No hay errores de JavaScript por elementos DOM inexistentes

## ğŸ§ª Testing Recomendado

1. **Probar Calendar:** 
   - Navegar a `/public/tasks/calendar.php`
   - Cambiar de mes usando los botones
   - Verificar que no haya errores en logs

2. **Probar Achievements:**
   - Navegar a `/public/gamification/achievements.php`
   - Verificar que muestre "X / Y logros" correctamente
   - Verificar progreso de porcentaje

3. **Probar Mark Deployed:**
   - Ir a una tarea pendiente
   - Click en "Marcar como Desplegada"
   - Llenar el formulario y enviar
   - Verificar que se marque correctamente sin error 500

4. **Probar Quick Tasks (despuÃ©s de migraciÃ³n):**
   - Navegar a `/public/tasks/quick_tasks.php`
   - Si no migrado: ver mensaje de advertencia
   - DespuÃ©s de migrar: crear, completar y eliminar tareas

## ğŸ“Š ValidaciÃ³n

Todos los errores identificados en los logs han sido corregidos:
- âœ… calendar.php lÃ­nea 33-35
- âœ… achievements.php lÃ­nea 37 (campo 'unlocked' â†’ 'is_unlocked')
- âœ… TaskService.php lÃ­nea 191
- âœ… QuickTaskService.php lÃ­nea 52 (manejo de tabla inexistente)
